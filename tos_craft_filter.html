<!DOCTYPE html>
<html>
<!-- Last modified : 2020.02.19 15:48 -->
<head>
    <title>神魔之塔龍刻搜尋器</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="./css/bootstrap.min.css">
    <link rel="stylesheet" href="./css/font-awesome.min.css">
    <script src="./js/jquery.min.js"></script>
    <script src="./js/popper.min.js"></script>
    <script src="./js/bootstrap.min.js"></script>
    <script src="./js/data.js"></script>
</head>
<style type="text/css">
    body {
        font-family: Microsoft JhengHei;
    }
    .filter[type=checkbox] {
        display: none;
    }
    .filter[type=checkbox]:checked + label.filter-btn {
        background-color: rgb(100, 100, 255); 
        color: rgb(255, 255, 255); 
        font-weight: bold;
    }
    .filter[type=checkbox]:checked + label.keyword-btn {
        background-color: rgb(107, 0, 152); 
        color: rgb(255, 255, 255); 
        font-weight: bold;
    }
    .filter[type=checkbox]:checked + label:not(.filter-btn):not(.keyword-btn) {
        background-color: rgb(50, 155, 50); 
        color: rgb(255, 255, 255); 
        font-weight: bold;
    }
    .filter[type=checkbox] + label {
        transition: 0.5s;
        cursor: pointer;
        border: 1px solid black;
        border-radius: 5px;
    }
    .navbar-brand, .navbar-brand:hover {
        font-size: 1.6vw;
        color: #d6d6d6;
        text-decoration: none;
    }
    .filter {
        width: 80%;
    }
    hr {
        width: 100%;
    }
    input[type=range]{
        width: 60%;
    }
    input[type=text]{
        text-align: center;
    }
    select {
        width: 100%;
        border-radius: 5px;
    }
    
    .row_title {
        font-size: 3vw;
    }
    .genre_label {
        font-size: 2.5vw;
    }
    .btn-shell {
        padding: 3px;
    }
    .filter-btn, .mode-btn, .attr-btn, .race-btn, .star-btn, .charge-btn, .keyword-btn {
        font-size: 1.6vw;
        font-weight: normal;
        color: black;
        text-align: center;
        border: 1px solid black;
        border-radius: 5px;
        cursor: pointer;
        padding: 5px 0;
    }
    .skill-group {
        width: 100%;
        margin: 30px 0;
    }
    
    .top-btn {
        font-size: 1.5vw;
    }
    .result {
        margin: 8px 0;
    }
    .tag_wrapper {
        width: 25%;
        padding: 5px;
    }
    .skill_tag, .genre_tag {
        font-size: 1.3vw;
        font-weight: bold;
        border-radius: 5px;
        color: white;
        text-align: center;
        padding: 5px;
        cursor: default;
    }
    .skill_tag {
        background-color: rgb(100, 100, 255);
    }
    .genre_tag {
        background-color: rgb(50, 155, 50);
    }
    .monster_img {
        width: 100%;
    }
    .monsterId {
        width: 100%;
        text-align: center;
        background-color: black;
        color: white;
        font-weight: bold;
    }
    .tooltip-inner {
        max-width: 500px;
        font-size: 1.4em;
        word-wrap: break-word;
        text-align: left;
    }
    .skill_tooltip {
        font-family: Microsoft JhengHei;
        margin: auto;
    }
    
    .toTop {
        width: 3rem;
        height: 3rem;
        padding: 0;
        margin: 0;
        border: 0;
        border-radius: 20%;
        opacity: 0.6;
        background: #000;
        cursor: pointer;
        position:fixed;
        right: 1rem;
        bottom: 1rem;
        display: none;
    }
    .toTop::before, .toTop::after {
        width: 25px;
        height: 6px;
        border-radius: 3px;
        background: #FFF;
        position: absolute;
        content: "";
    }
    .toTop::before {
        transform: rotate(-45deg) translate(0, -50%);
        left: 0.42rem;
    }
    .toTop::after {
        transform: rotate(45deg) translate(0, -50%);
        right: 0.42rem;
    }
    .toTop:focus {
        outline: none;
    }
    
    
    
    .keyword-input {
        font-size: 1.3vw;
        font-weight: normal;
        color: black;
        text-align: center;
        border: 1px solid #AAAAAA;
        border-radius: 5px;
    }
    
</style>

<script type="text/javascript" charset="UTF-8">
    var skill_type_string = [
    ["符石轉水", "符石轉火", "符石轉木", "符石轉光", "符石轉暗", "符石轉心", "符石強化"],
    ["直行轉水", "直行轉火", "直行轉木", "直行轉光", "直行轉暗", "直行轉心"],
    ["水屬追打", "火屬追打", "木屬追打", "光屬追打", "暗屬追打", "無屬追打"],
    ["減傷", "意志", "迴避", "回血", "我方傷害吸收"],
    ["直傷", "全體直傷", "單體破防直傷"],
    ["增傷", "增回", "破防", "反擊"],
    ["對水增傷", "對火增傷", "對木增傷", "對光增傷", "對暗增傷"],
    ["延遲", "減CD", "單體轉全體", "無視屬性相剋"],
    ["無視拼圖盾", "無視五屬盾", "無視攻前盾"]
    ];
    
    var mode_type_string = ["連鎖龍紋", "轉動龍印", "破碎龍咒", "映照龍符", "疾速龍玉", "裂空龍刃", "落影龍璃", "擴散龍結", "鏡像龍丸", "節奏龍弦"];
    
    var attr_type_string = ["沒有限制", "水", "火", "木", "光", "暗"];
    
    var race_type_string = ["沒有限制", "人類", "獸類", "妖精類", "龍類", "神族", "魔族", "機械族"];
    
    var star_type_string = ["1", "2", "3"];
    
    var charge_type_string = ["消除水符石", "消除火符石", "消除木符石", "消除光符石", "消除暗符石", "消除心符石", "消除符石", "發動攻擊", "受到攻擊", "4 Combo以上"]
    
    
    var filter_set = new Set();
    var blue_str = "rgb(100, 100, 255)";
    var green_str = "rgb(50, 155, 50)";
    var white_str = "rgb(255, 255, 255)";
    var black_str = "rgb(0, 0, 0)";
    var or_filter = true;
    var keyword_search = false;
    var input_maxlength = 50;
    
    const skill_num = skill_type_string.length;
    const mode_num = mode_type_string.length;
    const attr_num = attr_type_string.length;
    const race_num = race_type_string.length;
    const star_num = star_type_string.length;
    const charge_num = charge_type_string.length;
    
    const encode_chart = [
        "0","1","2","3","4","5","6","7","8","9",
        "a","b","c","d","e","f","g","h","i","j",
        "k","l","m","n","o","p","q","r","s","t",
        "u","v","w","x","y","z","A","B","C","D",
        "E","F","G","H","I","J","K","L","M","N",
        "O","P","Q","R","S","T","U","V","W","X",
        "Y","Z","+","-"
    ];
    
    const attr_zh_to_en = {"水": "w", "火": "f", "木": "e", "光": "l", "暗": "d"};
    
    $(document).ready(function(){
        init();
        $("#start_filter").on("click", startFilter);
        $("#and_or_filter").on("click", andOrChange);
        $("#reset_skill").on("click", resetSkill);
        $("#reset_all").on("click", resetAll);
        $("#reset_mode").on("click", resetMode);
        $("#reset_attr").on("click", resetAttr);
        $("#reset_race").on("click", resetRace);
        $("#reset_star").on("click", resetStar);
        $("#reset_charge").on("click", resetCharge);
        $("#reset_keyword").on("click", resetKeyword);
        $("#keyword-switch").on("click", keywordSwitch);
        
        if(location.search) readUrl();
    });
    
    $(window).resize(function(){
        if(window.matchMedia("(min-width: 768px)").matches)
        {
            $(".navbar-btn").css({"margin-top": ($(".navrow").height()-$(".navbar-btn").height())/2});
        }
        else
        {
            $(".navbar-btn").css({"margin-top": 0});
        }
    });
    
    function init()
    {
        $(".row.result-row").hide();
        
        $('#toTop-btn').click(function()
        { 
            $('html,body').animate({scrollTop:0}, 300);
        });
        $(window).scroll(function()
        {
            if ($(this).scrollTop() > 300) $('#toTop-btn').fadeIn(200);
            else $('#toTop-btn').stop().fadeOut(200);
        }).scroll();
        
        var i = 0;
        $(".filter-row").html(function()
        {
            var str = $(".filter-row").html();
            for(var x of skill_type_string)
            {
                str += "<div class='col-12 my-2'></div>";
                for(var s of x)
                {   
                    str += "<div class='col-6 col-md-4 col-lg-2 btn-shell'><input type='checkbox' class='filter' id='filter-"+i+"'><label class='p-1 w-100 text-center filter-btn' for='filter-"+i+"'>"+s+"</label></div>";
                    i ++;
                }
            }
            return str;
        });
        
        $(".keyword-row").html(function()
        {
            var str = $(".keyword-row").html();
            str += "<div class='col-12 my-2'></div>";
            str += "<div class='col-12 col-md-4 col-lg-2 btn-shell'><input type='checkbox' class='filter' id='keyword-switch'><label class='p-1 w-100 text-center keyword-btn' for='keyword-switch'>關鍵字搜尋</label></div>";
            str += "<div class='col-12 col-md-8 col-lg-10 btn-shell'><input type='text' class='form-control keyword-input' id='keyword-input' placeholder='輸入技能關鍵字' maxlength="+input_maxlength+" disabled></div>";
            return str;
        });
        
        $(".mode-row").html(function()
        {
            var str = $(".mode-row").html();
            str += "<div class='col-12 my-2'></div>";
            for(var x of mode_type_string)
            {
                str += "<div class='col-6 col-md-4 col-lg-2 btn-shell'><input type='checkbox' class='filter' id='filter-"+i+"'><label class='p-1 w-100 text-center mode-btn' for='filter-"+i+"'>"+x+"</label></div>";
                i ++;
            }
            return str;
        });
        
        $(".attr-row").html(function()
        {
            var str = $(".attr-row").html();
            str += "<div class='col-12 my-2'></div>";
            for(var x of attr_type_string)
            {
                str += "<div class='col-6 col-md-4 col-lg-2 btn-shell'><input type='checkbox' class='filter' id='filter-"+i+"'><label class='p-1 w-100 text-center attr-btn' for='filter-"+i+"'>"+x+"</label></div>";
                i ++;
            }
            return str;
        });
        
        $(".race-row").html(function()
        {
            var str = $(".race-row").html();
            str += "<div class='col-12 my-2'></div>";
            for(var x of race_type_string)
            {
                str += "<div class='col-6 col-md-4 col-lg-2 btn-shell'><input type='checkbox' class='filter' id='filter-"+i+"'><label class='p-1 w-100 text-center race-btn' for='filter-"+i+"'>"+x+"</label></div>";
                i ++;
            }
            return str;
        });
        
        $(".star-row").html(function()
        {
            var str = $(".star-row").html();
            str += "<div class='col-12 my-2'></div>";
            for(var x of star_type_string)
            {
                str += "<div class='col-6 col-md-4 col-lg-2 btn-shell'><input type='checkbox' class='filter' id='filter-"+i+"'><label class='p-1 w-100 text-center star-btn' for='filter-"+i+"'>"+x+" ★</label></div>";
                i ++;
            }
            return str;
        });
        
        $(".charge-row").html(function()
        {
            var str = $(".charge-row").html();
            str += "<div class='col-12 my-2'></div>";
            for(var x of charge_type_string)
            {
                str += "<div class='col-6 col-md-4 col-lg-2 btn-shell'><input type='checkbox' class='filter' id='filter-"+i+"'><label class='p-1 w-100 text-center charge-btn' for='filter-"+i+"'>"+x+"</label></div>";
                i ++;
            }
            return str;
        });
        
        or_filter = true;
        keyword_search = false;
    }
    
    function keywordSwitch()
    {
        if($("#keyword-switch").prop('checked'))
        {
            $('#keyword-input').attr('disabled', false);
            $('#keyword-input').css('border', '1px solid #000000');
            keyword_search = true;
            
            $(".filter-row .filter").each(function(){
                $(this).attr('disabled', true);
                $(this).next().css({
                    'border': '1px solid #AAAAAA', 
                    'color': '#AAAAAA', 
                    'background-color': '#E9ECEF', 
                    'cursor': 'default', 
                    'font-weight': 'normal'
                });
            });
        }
        else
        {
            $('#keyword-input').attr('disabled', true);
            $('#keyword-input').css('border', '1px solid #AAAAAA');
            keyword_search = false;
            
            $(".filter-row .filter").each(function(){
                $(this).attr('disabled', false);
                $(this).next().removeAttr('style');
            });
        }
    }
    
    function startFilter()
    {
        changeUrl();
        
        if(keyword_search == false)
        {
            filter_set.clear();
        
            var filter_charge_set = new Set();
        
            var skill_set = new Set();
            var skill_select = false;
            
            skill_set.clear();
            
            $(".filter-row .filter").each(function(){
                if($(this).prop('checked'))
                {
                    skill_set.add($(this).next("label").text());
                    skill_select = true;
                }
            });
            if(keyword_search == false && skill_select == false)
            {
                errorAlert(2);
                return ;
            }
            
            var mode_set = new Set();
            var mode_intersect = false;
            
            $(".mode-row .filter").each(function(){
                if($(this).prop('checked'))
                {
                    mode_set.add($(this).next("label").text());
                    mode_intersect = true;
                }
            });
            
            var attr_set = new Set();
            var attr_intersect = false;
            
            $(".attr-row .filter").each(function(){
                if($(this).prop('checked'))
                {
                    attr_set.add($(this).next("label").text());
                    attr_intersect = true;
                }
            });
            
            var race_set = new Set();
            var race_intersect = false;
            
            $(".race-row .filter").each(function(){
                if($(this).prop('checked'))
                {
                    race_set.add($(this).next("label").text());
                    race_intersect = true;
                }
            });
            
            var star_set = new Set();
            var star_intersect = false;
            
            $(".star-row .filter").each(function(){
                if($(this).prop('checked'))
                {
                    star_set.add(parseInt($(this).next("label").text()[0]));
                    star_intersect = true;
                }
            });
            
            var charge_set = new Set();
            var charge_intersect = false;
            
            $(".charge-row .filter").each(function(){
                if($(this).prop('checked'))
                {
                    charge_set.add($(this).next("label").text());
                    charge_intersect = true;
                }
            });
            
            for(var x of craft_data)
            {
                if(mode_intersect)
                {
                    if(!(mode_set.has(x.mode))) continue;
                }
                if(attr_intersect)
                {
                    if(!(attr_set.has(x.attribute))) continue;
                }
                if(race_intersect)
                {
                    if(!race_set.has(x.race)) continue;
                }
                if(star_intersect)
                {
                    if(!star_set.has(x.star)) continue;
                }
                if(charge_intersect)
                {
                    if(!charge_set.has(x.charge)) continue;
                }
                
                if(or_filter)
                {
                    var check = false;
                    for(var k of skill_set)
                    {
                        if(x.tag.includes(k))
                        {
                            check = true;
                            break;
                        }
                    }
                    
                    if(!check) continue;
                }
                else
                {
                    var check = true;
                    for(var k of skill_set)
                    {
                        if(!x.tag.includes(k))
                        {
                            check = false;
                            break;
                        }
                    }
                    
                    if(!check) continue;
                }
                
                if(x.tag.length > 0) filter_set.add(x.id);
            }
        }
        else
        {
            filter_set.clear();
        
            var filter_charge_set = new Set();
        
        
            /* keyword input check */
            var keyword = textSanitizer($('#keyword-input').val());
            if(keyword.length <= 0)
            {
                errorAlert(3);
                return;
            }
            else if(keyword.length > input_maxlength)
            {
                errorAlert(4);
                return;
            }
            
            /* keyword input split */
            var keyword_set = new Set();
            var keyword_select = false;
            
            keyword_set.clear();
            
            var keywords = keyword.split(',');
            keywords.forEach(function(element){
                if(element.length > 0 && element.length <= 50) keyword_set.add(element);
            });
            
            if(keyword_set.size <= 0)
            {
                errorAlert(3);
                return;
            }
            
            var mode_set = new Set();
            var mode_intersect = false;
            
            $(".mode-row .filter").each(function(){
                if($(this).prop('checked'))
                {
                    mode_set.add($(this).next("label").text());
                    mode_intersect = true;
                }
            });
            
            var attr_set = new Set();
            var attr_intersect = false;
            
            $(".attr-row .filter").each(function(){
                if($(this).prop('checked'))
                {
                    attr_set.add($(this).next("label").text());
                    attr_intersect = true;
                }
            });
            
            var race_set = new Set();
            var race_intersect = false;
            
            $(".race-row .filter").each(function(){
                if($(this).prop('checked'))
                {
                    race_set.add($(this).next("label").text());
                    race_intersect = true;
                }
            });
            
            var star_set = new Set();
            var star_intersect = false;
            
            $(".star-row .filter").each(function(){
                if($(this).prop('checked'))
                {
                    star_set.add(parseInt($(this).next("label").text()[0]));
                    star_intersect = true;
                }
            });
            
            var charge_set = new Set();
            var charge_intersect = false;
            
            $(".charge-row .filter").each(function(){
                if($(this).prop('checked'))
                {
                    charge_set.add($(this).next("label").text());
                    charge_intersect = true;
                }
            });
            
            for(var x of craft_data)
            {
                if(mode_intersect)
                {
                    if(!(mode_set.has(x.mode))) continue;
                }
                if(attr_intersect)
                {
                    if(!(attr_set.has(x.attribute))) continue;
                }
                if(race_intersect)
                {
                    if(!race_set.has(x.race)) continue;
                }
                if(star_intersect)
                {
                    if(!star_set.has(x.star)) continue;
                }
                if(charge_intersect)
                {
                    if(!charge_set.has(x.charge)) continue;
                }
                
                if(or_filter)
                {
                    if(x.description.length <= 0) continue;
                    
                    var check = false;
                    var skill_desc = x.description.map(function(e){
                        return textSanitizer(e);
                    });
                    for(var k of keyword_set)
                    {
                        for(var s of skill_desc)
                        {
                            if(s.includes(k))
                            {
                                check = true;
                                filter_set.add(x.id);
                                break;
                            }
                        }
                        if(check) break;
                    }
                }
                else
                {
                    if(x.description.length <= 0) continue;
                    
                    var check = true;
                    var skill_desc = x.description.map(function(e){
                        return textSanitizer(e);
                    }); 
                    for(var k of keyword_set)
                    {
                        var isKeywordInDesc = false;
                        for(var s of skill_desc)
                        {
                            if(s.includes(k))
                            {
                                isKeywordInDesc = true;
                                break;
                            }
                        }
                        if(isKeywordInDesc) continue;
                        else
                        {
                            check = false;
                            break;
                        }
                    }
                    
                    if(check) filter_set.add(x.id);
                }
                
                
            }
        }
        
        
        $(".row.result-row").show();
        
        var craft_array = Array.from(filter_set);
        $("#result-row").html(function()
        {
            var str = "";
            if(craft_array.length != 0)
            {
                craft_array.sort((a, b) => a - b);
                craft_array.forEach(function(x) {
                
                    var sk_str = "";
                    var skill_cnt = 0;
                    
                    var skill = craft_data.find(function(element){
                        return element.id == x;
                    }).description;
                    
                    for(var s of skill)
                    {
                        if(skill_cnt > 0) sk_str += "<hr style='margin: 5px 0;'>";
                    
                        skill_cnt ++;
                        sk_str += "<div class='skill_tooltip skill_description'><img src='./img/skill_"+skill_cnt+".png' />&nbsp;"+s+"</div>";
                    }
                    
                    
                    str += "<div class=\"col-3 col-md-2 col-lg-1  result\" data-toggle=\"tooltip\" data-html=\"true\" title=\""+sk_str+"\"><a href=\"http://tosapp.mofang.com.tw/rk-"+x+".html\" target=\"_blank\"><img class=\"monster_img\" src=\"./img/"+x+".png\" title=\""+x+"\" onerror=\"this.src='./img/noname.png'\"></img></a><div class=\"monsterId\">"+paddingZeros(x, 3)+"</div></div>";
                });
            }
            else
            {
                str = "<div class='col-sm-12' style=\"text-align: center; color: #888888;\"><h1>查無結果</h1></div>";
            }
            return str;
        });
        
        $('.result').tooltip({ boundary: 'scrollParent', placement: 'auto', container: 'body'});
        
        $(".search_tag").html(function(){
            var tag_html = "";
            
            if(!keyword_search)
            {
                skill_set.forEach(function(element){
                    tag_html += '<div class="tag_wrapper"><div class="skill_tag" title="'+element+'">'+element+'</div></div>';
                });
            }
            mode_set.forEach(function(element){
                tag_html += '<div class="tag_wrapper"><div class="genre_tag" title="'+element+'">'+element+'</div></div>';
            });
            attr_set.forEach(function(element){
                tag_html += '<div class="tag_wrapper"><div class="genre_tag" title="'+element+'">'+element+'</div></div>';
            });
            race_set.forEach(function(element){
                tag_html += '<div class="tag_wrapper"><div class="genre_tag" title="'+element+'">'+element+'</div></div>';
            });
            star_set.forEach(function(element){
                tag_html += '<div class="tag_wrapper"><div class="genre_tag" title="'+element+' ★">'+element+" ★"+'</div></div>';
            });
            charge_set.forEach(function(element){
                tag_html += '<div class="tag_wrapper"><div class="genre_tag" title="'+element+'">'+element+'</div></div>';
            });
            return tag_html;
        });
        
        jumpTo("result_title");
    }
    
    function paddingZeros(x, num)
    {
        if(x.toString().length < num)
        {
            return "0".repeat(num-x.toString().length)+x.toString();
        }
        else
        {
            return x.toString();
        }
    }
    
    function andOrChange()
    {
        or_filter = !or_filter;
        if(or_filter == false)
        {
            $("#and_or_filter").removeClass("btn-warning").addClass("btn-danger").text("AND 搜尋");
        }
        else
        {
            $("#and_or_filter").removeClass("btn-danger").addClass("btn-warning").text("OR 搜尋");
        }
    }
    
    function resetSkill()
    {
        $(".filter-btn").each(function(){
            $(this).css("background-color", white_str);
            $(this).css("color", black_str);
            $(this).css("font-weight", "normal");
        });
        filter_set.clear();
    }
    
    function resetMode()
    {
        $(".mode-btn").each(function(){
            $(this).css("background-color", white_str);
            $(this).css("color", black_str);
            $(this).css("font-weight", "normal");
        });
        filter_set.clear();
    }
    
    function resetAttr()
    {
        $(".attr-btn").each(function(){
            $(this).css("background-color", white_str);
            $(this).css("color", black_str);
            $(this).css("font-weight", "normal");
        });
        filter_set.clear();
    }
    
    function resetRace()
    {
        $(".race-btn").each(function(){
            $(this).css("background-color", white_str);
            $(this).css("color", black_str);
            $(this).css("font-weight", "normal");
        });
        filter_set.clear();
    }
    
    function resetStar()
    {
        $(".star-btn").each(function(){
            $(this).css("background-color", white_str);
            $(this).css("color", black_str);
            $(this).css("font-weight", "normal");
        });
        filter_set.clear();
    }
    
    function resetCharge()
    {
        $(".charge-btn").each(function(){
            $(this).css("background-color", white_str);
            $(this).css("color", black_str);
            $(this).css("font-weight", "normal");
        });
        filter_set.clear();
    }
    
    function resetKeyword()
    {
        $("#keyword-input").val('');
    }
    
    function resetAll()
    {
        resetSkill();
        resetMode();
        resetAttr();
        resetRace();
        resetStar();
        resetCharge();
        resetKeyword();
    }
    
    function changeUrl()
    {
        var str = "";
        
        if(!keyword_search) str += "search=" + encode(".filter-row", skill_num);
        else str += "keyword=" + escape(textSanitizer($('#keyword-input').val()));
        str += "&mode=" + encode(".mode-row", mode_num);
        str += "&attr=" + encode(".attr-row", attr_num);
        str += "&race=" + encode(".race-row", race_num);
        str += "&star=" + encode(".star-row", star_num);
        str += "&chrg=" + encode(".charge-row", charge_num);
        str += "&or=" + (or_filter?"1":"0");
        
        window.history.pushState(null, null, "?"+str);
    }
    
    function readUrl()
    {
        var code_array = location.search.split("&").map(x => x.split("=")[1]);
        var code_name_array = location.search.split("?")[1].split("&").map(x => x.split("=")[0]);
        
        if(code_array.length != 7)
        {
            errorAlert(1);
            return;
        }
        var code_name_1 = ["search", "mode", "attr", "race", "star", "chrg", "or"];
        var code_name_2 = ["keyword", "mode", "attr", "race", "star", "chrg", "or"];
        
        for(var i in code_name_array)
        {
            if(code_name_array[i] !== code_name_1[i] && code_name_array[i] !== code_name_2[i])
            {
                errorAlert(1);
                return;
            }
        }
        
        if(code_name_array[0] == code_name_1[0])
        {
            var skill_code = decode(code_array[0]);
            setButtonFromUrl(".filter-row", skill_code, resetSkill);
        }
        else
        {
            var skill_keyword = code_array[0];
            setInputFromUrl(".keyword-input", unescape(skill_keyword));
            $("#keyword-switch").click();
            keywordSwitch();
        }
        
        var mode_code = decode(code_array[1]);
        setButtonFromUrl(".mode-row", mode_code, resetMode);
        
        var attr_code = decode(code_array[2]);
        setButtonFromUrl(".attr-row", attr_code, resetAttr);
        
        var race_code = decode(code_array[3]);
        setButtonFromUrl(".race-row", race_code, resetRace);
        
        var star_code = decode(code_array[4]);
        setButtonFromUrl(".star-row", star_code, resetStar);
        
        var chrg_code = decode(code_array[5]);
        setButtonFromUrl(".charge-row", chrg_code, resetCharge);
        
        var and_or_code = code_array[6];
        if(and_or_code[0] == "0") andOrChange();
        
        startFilter();
        
        window.history.pushState(null, null, location.pathname);    // clear search parameters
    }
    
    function encode(type, max_num)
    {
        var cnt = 1, enc_bin = 0;
        var str = "";
        
        $(type+' .filter').each(function(){
            enc_bin = enc_bin * 2 + ($(this).prop('checked')?1:0);
            if(cnt % 6 == 0)
            {
                str += encode_chart[enc_bin];
                enc_bin = 0;
            }
            cnt ++;
        });
        
        while(cnt % 6 != 1)     // padding for zeros
        {
            enc_bin = enc_bin * 2;
            if(cnt % 6 == 0)
            {
                str += encode_chart[enc_bin];
                enc_bin = 0;
            }
            cnt ++;
        }

        return str;
    }
    
    function decode(data)
    {
        var bin_str = "";
        for(let c of data)
        {
            for(let i in encode_chart)
            {
                if(c == encode_chart[i])
                {
                    var bin_str_part = "";
                    for(let k=0; k<6; k++)
                    {
                        bin_str_part += (i % 2).toString();
                        i = Math.trunc(i / 2);
                    }
                    bin_str += bin_str_part.split('').reverse().join('');
                }
            }
        }

        return bin_str;
    }
    
    function setButtonFromUrl(type, data, callback)
    {
        callback();
        
        var cnt = 0;
        $(type+' .filter').each(function(){
            if(data[cnt] == '1') $(this).click();
            cnt ++;
        });
    }
    
    function setInputFromUrl(element, data)
    {
        $(element).val(data);
    }
    
    function getPosition(element)
    {
        var e = document.getElementById(element);
        var left = 0;
        var top = 0;
        var top_padding_offset = 90;

        do
        {
            left += e.offsetLeft;
            top += e.offsetTop;
        }while(e = e.offsetParent);

        return [0, top-top_padding_offset];
    }

    function jumpTo(id)
    {
        window.scrollTo(getPosition(id)[0], getPosition(id)[1]);
    }
    
    function errorAlert(index)
    {
        switch(index) {
            case 1:
                alert("[Error Code 01] 請檢查網址是否正確");
            break;
            case 2:
                alert("[Error Code "+paddingZeros(index, 2)+"] 請先選擇功能或輸入技能關鍵字");
            break;
            case 3:
                alert("[Error Code "+paddingZeros(index, 2)+"] 請輸入技能關鍵字");
            break;
            case 4:
                alert("[Error Code "+paddingZeros(index, 2)+"] 技能關鍵字數量不得超過 "+input_maxlength);
            break;
            default:
                
        }
    }
    
    function textSanitizer(text)
    {
        return text.replace(/<br>/g,'').replace(/\s/g,'').toLowerCase();
    }
    
</script>

<body>
    <div class="container-fluid sticky-top bg-dark py-1">
        <div class="row">
            <div class="col-12 col-lg-4">
                <a class="navbar-brand" id="navtitle" href="#">神魔之塔龍刻搜尋器</a>
                <a class="navbar-brand" target="_blank" href="https://forum.gamer.com.tw/Co.php?bsn=23805&sn=3623648"><i class="fa fa-question-circle"></i></a>
            </div>
            <div class="col-12 col-lg-8">
                <div class="row">
                    <div class="col-12 col-sm-3 mb-1"></div>
                    <div class="col-12 col-sm-3 mb-1">
                        <button type="button" class="btn btn-primary btn-block top-btn reset" id="reset_all">
                            <i class="fa fa-undo"></i>
                            &nbsp;全部重置
                        </button>
                    </div>
                    <div class="col-12 col-sm-3 mb-1">
                        <button type="button" class="btn btn-warning btn-block top-btn and_or_mode" id="and_or_filter">
                            OR 搜尋
                        </button>
                    </div>
                    <div class="col-12 col-sm-3 mb-1">
                        <button type="button" class="btn btn-success btn-block top-btn start-btn" id="start_filter">
                            <i class="fa fa-play-circle"></i>
                            &nbsp;&nbsp;搜尋
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="filter container">
        <div class="row">
            <div class="col-12 mt-5">
                <h1>搜尋條件</h1>
            </div>
            <div class="col-12">
                <hr>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <h3>功能</h3>
            </div>
            <div class="col-12 btn-shell">
                <button class="btn btn-primary btn-block top-btn reset" id="reset_skill">
                    <i class="fa fa-undo"></i>
                    &nbsp;&nbsp;重置
                </button>
            </div>
        </div>
        <div class="row filter-row"></div>
        <div class="row">
            <div class="col-12">
                <hr>
                <h3>關鍵字搜尋</h3>
            </div>
            <div class="col-12 btn-shell">
                <button class="btn btn-primary btn-block top-btn reset" id="reset_keyword">
                    <i class="fa fa-undo"></i>
                    &nbsp;&nbsp;重置
                </button>
            </div>
        </div>
        <div class="row keyword-row"></div>
        <div class="row">
            <div class="col-12">
                <hr>
                <h3>龍刻模式</h3>
            </div>
            <div class="col-12 btn-shell">
                <button class="btn btn-primary btn-block top-btn reset" id="reset_mode">
                    <i class="fa fa-undo"></i>
                    &nbsp;&nbsp;重置
                </button>
            </div>
        </div>
        <div class="row mode-row"></div>
        <div class="row">
            <div class="col-12">
                <hr>
                <h3>裝備屬性</h3>
            </div>
            <div class="col-12 btn-shell">
                <button class="btn btn-primary btn-block top-btn reset" id="reset_attr">
                    <i class="fa fa-undo"></i>
                    &nbsp;&nbsp;重置
                </button>
            </div>
        </div>
        <div class="row attr-row"></div>
        <div class="row">
            <div class="col-12">
                <hr>
                <h3>裝備種族</h3>
            </div>
            <div class="col-12 btn-shell">
                <button class="btn btn-primary btn-block top-btn reset" id="reset_race">
                    <i class="fa fa-undo"></i>
                    &nbsp;&nbsp;重置
                </button>
            </div>
        </div>
        <div class="row race-row"></div>
        <div class="row">
            <div class="col-12">
                <hr>
                <h3>龍刻稀有度</h3>
            </div>
            <div class="col-12 btn-shell">
                <button class="btn btn-primary btn-block top-btn reset" id="reset_star">
                    <i class="fa fa-undo"></i>
                    &nbsp;&nbsp;重置
                </button>
            </div>
        </div>
        <div class="row star-row"></div>
        <div class="row">
            <div class="col-12">
                <hr>
                <h3>龍刻集氣條件</h3>
            </div>
            <div class="col-12 btn-shell">
                <button class="btn btn-primary btn-block top-btn reset" id="reset_charge">
                    <i class="fa fa-undo"></i>
                    &nbsp;&nbsp;重置
                </button>
            </div>
        </div>
        <div class="row charge-row"></div>
        <div class="row result-row">
            <div class="col-12">
                <hr>
            </div>
            <div class="col-12" id="result_title">
                <h1>搜尋結果</h1>
            </div>
            <div class="col-12 search_tag d-flex flex-wrap">
                
            </div>
            <div class="col-12">
                <div class="row" id="result-row">
                    
                </div>
            </div>
        </div>
        <div class="row my-5"></div>
    </div>
    <button type="button" id="toTop-btn" class="toTop"></button>
    
</body>
</html>